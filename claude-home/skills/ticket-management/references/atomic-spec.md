Atomic Spec: AI Agent がコンテキストウィンドウ単位（2-4 時間推論）で完結できるチケットの書き方。

## 定義

Atomic Spec は、AI Agent が 1 セッション内で「理解 → 計画 → 実装 → テスト」を完結できる最小仕様単位。
従来の「1-3 営業日」ではなく、コンテキストウィンドウに収まるサイズで分割する。

**分割基準**:
- AI Agent が 4-6 ターンで実装完了できるサイズ
- 変更ファイル数: 5 ファイル以下が目安
- PR 差分: 300 行以下が目安
- 見積もり不能: 調査チケット（Spike）として分離し、2 時間のタイムボックスを設定

## 必須 5 要素

### 1. Context（背景）

ビジネスと技術の両方のコンテキストを記述する。AI Agent が「なぜこの変更が必要か」を理解できる情報量。

- **ビジネスコンテキスト**: ユーザー影響、ビジネス価値、優先度の根拠
- **技術コンテキスト**: アーキテクチャ上の位置づけ、関連システム

### 2. Current Behavior（現状）

現在の挙動を具体的に記述する。ファイルパスと定量データを含める。

- **ファイルパス**: 変更対象のエントリーポイントを明示（例: `src/auth/login.ts:42`）
- **定量データ**: エラー率、レスポンスタイム、発生頻度など
- **再現手順**（Bug の場合）: 前提条件 → 操作手順（番号付き）

### 3. Expected Behavior（あるべき姿）

変更後にどうなるべきかを記述する。曖昧な表現（「改善する」「良くする」）を避け、検証可能な状態を定義。

### 4. Constraints（制約条件）

AI Agent が守るべき制約を明示する。記述がないと AI が自由に判断してしまう。

- 禁止事項: 使用禁止のライブラリ、変更禁止のファイル
- パフォーマンス要件: レスポンスタイム上限、メモリ使用量
- 互換性: 既存 API との後方互換性
- セキュリティ: 認証・認可要件

### 5. Verification（検証方法）

AI Agent が自律実行できるテスト方法を記述する。「手動で確認」は不可。

- テストコマンド: `npm test -- --grep "auth"` のように実行可能な形式
- 期待結果: テストがパスする、lint エラーが 0 件、など
- 回帰テスト: 既存テストが引き続きパスすること

## タイプ別テンプレート

### Task テンプレート

> **Context**: [ビジネス背景] + [技術的位置づけ]
>
> **Current Behavior**: [現在の状態、関連ファイルパス]
>
> **Expected Behavior**: [実装後の挙動]
>
> **Constraints**: [禁止事項、パフォーマンス要件]
>
> **Verification**: [テストコマンド、期待結果]

### Bug テンプレート

> **Context**: [影響範囲、発生頻度、ビジネスインパクト]
>
> **Current Behavior**: [再現手順] → [実際の挙動、エラーメッセージ]
> ファイル: `src/path/to/file.ts:行番号`
> 環境: [OS / ブラウザ / バージョン]
>
> **Expected Behavior**: [本来の正しい挙動]
>
> **Constraints**: [修正時の制約]
>
> **Verification**: [再現手順で問題が発生しないこと + 回帰テスト追加]

### Improvement テンプレート

> **Context**: [改善の動機、ユーザーフィードバック]
>
> **Current Behavior**: [現状の課題、定量データ]
>
> **Expected Behavior**: [改善後の目標値]
>
> **Constraints**: [改善手法の制約]
>
> **Verification**: [計測コマンド、目標値の達成確認方法]

## 良い例 / 悪い例

### Task: 良い例

> タイトル: `OAuth2 コールバックエンドポイントを実装する`
>
> **Context**: SSO 要件対応。認証モジュール (`src/auth/`) に OAuth2 Authorization Code Flow を追加。
>
> **Current Behavior**: パスワード認証のみ対応。`src/auth/strategies/` に local.ts のみ存在。
>
> **Expected Behavior**: Google / GitHub OAuth2 コールバックを処理し、既存セッション管理と統合。
>
> **Constraints**: passport.js を使用。新規依存は passport-google-oauth20 と passport-github2 のみ。
>
> **Verification**: `npm test -- --grep "oauth"` で統合テストがパス。

### Task: 悪い例

> タイトル: `認証を改善する`
> OAuth 対応する。あとセキュリティも見直す。
> → 複数目的、ファイルパスなし、検証方法なし、Constraints なし

### Bug: 良い例

> タイトル: `ログインページで国際化メールアドレスがバリデーションエラーになる`
>
> **Context**: 週 3 件のサポート問い合わせ。日本語ドメインユーザーに影響。
>
> **Current Behavior**: 1. `/login` にアクセス → 2. `user@example.jp` を入力 → 3. 「無効なメールアドレス」エラー
> ファイル: `src/validators/email.ts:15` の正規表現が RFC 6531 非対応
> 環境: Chrome 131 / macOS 15.2 / v2.3.1
>
> **Expected Behavior**: RFC 6531 準拠のメールアドレスを受け付ける。
>
> **Constraints**: validator.js の `isEmail()` オプションで対応。カスタム正規表現は避ける。
>
> **Verification**: `npm test -- --grep "email validation"` + 国際化アドレスのテストケース追加。

### Bug: 悪い例

> タイトル: `ログインがおかしい`
> ログインできない時がある。
> → 再現手順なし、環境不明、「時がある」が曖昧、ファイルパスなし

## タイトルのパターン集

| カテゴリ | パターン | 例 |
|---|---|---|
| **機能追加** | `[機能]を実装する` | `二要素認証を実装する` |
| **バグ修正** | `[場所]で[症状]が発生する` | `決済画面でタイムアウトエラーが発生する` |
| **改善** | `[対象]の[指標]を改善する` | `ダッシュボードの初期表示速度を改善する` |
| **調査** | `[対象]を調査する` | `メモリリークの原因を調査する` |
| **リファクタ** | `[対象]を[方式]にリファクタする` | `認証モジュールを Strategy パターンにリファクタする` |

## Interaction Churn 判定

AI Agent とのプロンプト往復回数（Churn）が品質のシグナル:

| Churn 回数 | 判定 | アクション |
|---|---|---|
| 1-3 回 | 正常 | そのまま続行 |
| 4-6 回 | 注意 | Spec の曖昧箇所を特定・補足 |
| 7 回超 | 異常 | Spec Definition に差し戻し。5 要素を再記述 |
