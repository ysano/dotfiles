## ハイブリッド・ルーティング戦略

サブエージェントの `model:` フィールドを、タスク性質に基づき3カテゴリに分類して戦略的に固定する。

### 3カテゴリの定義

#### Utility Agents（常に最安モデル）

- **固定**: `model: haiku`
- **該当**: grep/検索、リンターエラー修正、フォーマット整形、CI パイプライン、コミットメッセージ生成
- **原則**: 親セッションが Opus でも、これらは常に Haiku で実行。自律的判断が不要な定型タスク

#### Critical Agents（常に高性能モデル）

- **固定**: `model: opus` または `model: sonnet`
- **該当**: セキュリティ監査、アーキテクチャレビュー、ルートコーズ分析
- **原則**: ユーザーがコスト削減のために安いモデルを使用中でも、品質を強制的に優先。見逃し（False Negative）のコストが無限大に近いタスク

#### Contextual Agents（親に追従）

- **固定**: `model: inherit`（デフォルト）
- **該当**: 計画立案、対話型レビュー、相談、ペアプログラミング
- **原則**: ユーザーの思考レベルに合わせる必要がある対話型タスク

### `model: inherit` の功罪

**利点**:
- 設定不要（デフォルト動作）
- ユーザーの意図に自然に追従
- 対話の文脈や推論レベルが一致

**リスク: コストの不可視化**:
- Opus セッション中の単純検索に Opus 単価が適用される
- Haiku の数十倍のコストが「見えないまま」消費される
- 大量のサブエージェント呼び出しでコストが爆発的に増大

### 戦略的モデル固定（Pinning）ルール

1. **デフォルトは inherit にしない**: 新規エージェント作成時、タスク性質を分析してから設定
2. **読み取り専用 → Haiku**: ファイル読み込み・検索のみなら迷わず Haiku
3. **品質ゲート → Opus/Sonnet**: セキュリティ・品質に関わるものは下限を設定
4. **対話型のみ inherit**: ユーザーとの双方向コミュニケーションが中心の場合のみ
5. **コスト監査を定期実施**: inherit のまま放置されたエージェントを棚卸し

### 判定フローチャート

```
タスクを分析
├─ 自律判断が不要？ （検索/リント/フォーマット）
│  └─ → model: haiku （Utility）
├─ 失敗コストが甚大？ （セキュリティ/アーキテクチャ）
│  └─ → model: opus or sonnet （Critical）
├─ ユーザーとの対話が中心？
│  └─ → model: inherit （Contextual）
└─ 上記に該当しない中間タスク？
   ├─ コード生成・修正あり → model: sonnet
   └─ 読み取り中心 → model: haiku
```

### ハイブリッド構成の実装例

```yaml
# Utility: 常に Haiku
---
name: code-searcher
model: haiku
tools: Read, Glob, Grep
---

# Critical: 常に Opus
---
name: security-auditor
model: opus
tools: Read, Glob, Grep, Bash
---

# Contextual: 親に追従
---
name: planning-advisor
# model: inherit (デフォルト、明示不要)
---
```

### アンチパターン

- **全エージェントを inherit**: コスト管理が不可能になる
- **全エージェントを haiku**: 品質ゲートが機能しなくなる
- **Opus の日常利用**: 経済的に正当化困難。Inception フェーズやレスキューに限定
- **設定後の放置**: モデル価格改定やベンチマーク変動に追従できない
