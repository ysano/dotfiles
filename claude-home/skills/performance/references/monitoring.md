# パフォーマンス監視セットアップ手順

APM/RUM/サーバー/DB の包括的パフォーマンス監視を以下の 10 ステップで設定する。

## 1. 監視戦略

- KPI と SLO を定義
- クリティカルユーザージャーニーとボトルネックを特定
- 監視アーキテクチャとデータ収集戦略を計画
- 既存の監視インフラと統合ポイントを評価
- アラート閾値とエスカレーション手順を定義

## 2. Application Performance Monitoring (APM)

ツール選定と設定:

- **New Relic**: distributed tracing、transaction tracer を有効化
- **Datadog**: dd-trace を設定、logInjection / runtimeMetrics / profiling を有効化
- **OpenTelemetry**: ベンダー非依存のオープンスタンダード

設定のポイント: サービス名、環境、バージョンを含めてトレーサビリティを確保。

## 3. Real User Monitoring (RUM)

- Web Vitals (LCP, INP, CLS, FCP, TTFB) の計測を実装
- カスタムメトリクス (API コール、コンポーネントレンダリング) を追加
- フレームワーク固有の監視 (React Profiler 等) を設定

## 4. サーバーパフォーマンス監視

- システムメトリクス収集: CPU、メモリ、ヒープ使用量、イベントループ遅延
- レスポンスタイム計測ミドルウェアを設定
- Prometheus メトリクスエンドポイントを公開

## 5. データベースパフォーマンス監視

DB 最適化の詳細は `database-optimization.md` を参照。

- スロークエリログを有効化 (閾値: 1s)
- クエリ実行時間の統計を収集
- コネクションプール使用率を監視

## 6. エラートラッキング

- Sentry 等のエラー監視ツールを設定
- パフォーマンス関連エラー (タイムアウト、OOM) の分類を定義
- ソースマップをアップロードしてスタックトレースを改善

## 7. カスタムメトリクス・ダッシュボード

- Prometheus / Grafana でカスタムダッシュボードを作成
- ビジネスメトリクス (コンバージョン率、リクエスト数) を統合
- パフォーマンスバジェットの遵守状況を可視化

## 8. アラートシステム

- 段階的アラート (Warning / Critical / Emergency) を設定
- 通知チャネル (Slack, Email, PagerDuty) を設定
- フラッピング防止と抑制ルールを定義
- エスカレーションポリシーを策定

## 9. パフォーマンステスト統合

- CI/CD パイプラインに負荷テストを統合
- ベースライン比較と回帰検知を自動化
- パフォーマンスバジェットのゲートチェックを設定

## 10. 最適化推奨の自動生成

- 収集データからボトルネックを自動検出するルールを設定
- レスポンスタイム / メモリ使用量 / CPU 使用率の閾値を定義
  - good: < 200ms / < 60% / < 50%
  - warning: < 1000ms / < 80% / < 70%
  - critical: > 3000ms / > 90% / > 85%

See also: ボトルネック特定には `performance-audit.md` を参照。
