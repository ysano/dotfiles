# 要約機能リファクタリング計画

## 目標
1. **責務の明確化**: 各モジュールの役割を明確に分離
2. **レイヤー設計の統一**: 適切な抽象化レベルの実現
3. **エラーハンドリング強化**: 堅牢性の向上
4. **保守性の向上**: コードの重複削除と一貫性確保

## リファクタリングステップ

### Phase 1: 基盤整備（優先度：高）
1. **存在しない依存関係の修正**
   - [ ] `capture_pane_content()`関数の実装または削除
   - [ ] `integration.sh`への依存を削除

2. **責務の明確化**
   - [ ] `llm_manager.sh`: 純粋なLLM通信層として整理
   - [ ] `summary_engine.sh`: ビジネスロジック層として整理
   - [ ] `screen_capture.sh`: データ取得層として整理

### Phase 2: インターフェース統一（優先度：高）
1. **API設計の統一**
   - [ ] 要約関数のインターフェースを統一
   - [ ] パラメータの標準化（content, options構造体）

2. **レイヤー違反の修正**
   - [ ] `claude-voice`が`summary_engine.sh`経由で要約を取得するよう修正
   - [ ] 直接的な低レベルAPI呼び出しを削除

### Phase 3: コード品質改善（優先度：中）
1. **命名規則の統一**
   - [ ] `generate_*` vs `summarize_*`の使い分けルール確立
   - [ ] 関数名の一貫性確保

2. **重複コードの削除**
   - [ ] コンテキスト判定ロジックの共通化
   - [ ] エラーハンドリングパターンの統一

### Phase 4: パフォーマンス最適化（優先度：低）
1. **呼び出しチェーンの最適化**
   - [ ] 不要な多段階呼び出しの削減
   - [ ] キャッシュ機構の導入検討

## 新しいアーキテクチャ

```
┌─────────────────────────────┐
│     claude-voice (UI層)      │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│  summary_engine.sh (ビジネス層) │
├─────────────────────────────┤
│ - generate_summary()         │
│ - SummaryOptions構造体       │
│ - コンテキスト判定          │
└──────────┬──────────────────┘
           ↓
┌──────────────────────────────┐
│   データアクセス層            │
├──────────────────────────────┤
│ screen_capture.sh            │
│ - capture_screen_content()   │
├──────────────────────────────┤
│ llm_manager.sh               │
│ - query_llm()                │
│ - get_best_model()           │
└──────────────────────────────┘
```

## 期待される成果
- コードの保守性向上: 50%削減された重複コード
- エラー率低下: 存在しない依存の解消
- 開発効率向上: 明確な責務分離による理解しやすさ
- テスト容易性: モジュール単位でのテスト実施可能