#!/bin/bash
# Claude Voice - Main Entry Point
# ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œã®çµ±åˆéŸ³å£°é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

# ç’°å¢ƒè¨­å®š
CLAUDE_VOICE_HOME="${CLAUDE_VOICE_HOME:-$HOME/.tmux/claude}"
export CLAUDE_VOICE_HOME

# åŸºæœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
if [[ -f "$CLAUDE_VOICE_HOME/core/base.sh" ]]; then
    source "$CLAUDE_VOICE_HOME/core/base.sh"
else
    echo "Error: Claude Voice core modules not found in $CLAUDE_VOICE_HOME" >&2
    exit 1
fi

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
claude_voice_init "${DEBUG_MODE:-false}"

# OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
if ! load_os_module; then
    log "ERROR" "Failed to load OS-specific module"
    exit 1
fi

# ãã®ä»–ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
for module in screen_capture llm_manager summary_engine; do
    module_path="$CLAUDE_VOICE_HOME/core/${module}.sh"
    if [[ -f "$module_path" ]]; then
        source "$module_path"
        log "DEBUG" "Loaded module: $module"
    else
        log "ERROR" "Required module not found: $module_path"
        exit 1
    fi
done

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
CONFIG_FILE="$CLAUDE_VOICE_HOME/config/claude-voice.conf"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
SUMMARY_TYPES=("brief" "detailed" "technical")
DEFAULT_LINES=50
DEFAULT_VOICE="Kyoko"
DEFAULT_DEVICE="system_default"
DEFAULT_MODEL="auto"

# ãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•°
main() {
    local summary_type="${1:-brief}"
    local lines="${2:-$DEFAULT_LINES}"
    local voice="${3:-$DEFAULT_VOICE}"
    local model="${4:-$DEFAULT_MODEL}"
    local device="${5:-$DEFAULT_DEVICE}"
    local target_window="${6:-.}"  # 6ç•ªç›®ã®å¼•æ•°ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦IDã‚’æŒ‡å®šå¯èƒ½
    
    log "INFO" "Starting claude-voice (OS: $(detect_os), type: $summary_type)"
    
    # å¼•æ•°ã®æ¤œè¨¼
    if ! validate_arguments "$summary_type" "$lines" "$voice" "$model"; then
        show_usage
        exit 1
    fi
    
    # éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
    if ! initialize_audio_subsystem; then
        log "ERROR" "Failed to initialize audio subsystem"
        exit 1
    fi
    
    local start_time=$(start_timer)
    
    # 1. ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£
    echo "ğŸ“º ç”»é¢å†…å®¹ã‚’å–å¾—ä¸­... (target: $target_window)"
    local screen_text
    if ! screen_text=$(capture_screen_text "$target_window" "$lines"); then
        local error_msg="ç”»é¢å†…å®¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        echo "âŒ $error_msg"
        speak_text "$error_msg" "$voice"
        exit 1
    fi
    
    local char_count=${#screen_text}
    echo "âœ… ${char_count}æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—"
    log "DEBUG" "Captured text preview: ${screen_text:0:100}..."
    
    # 2. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®åé›†
    local context=$(collect_context_information)
    log "DEBUG" "Context: $context"
    
    # 2.5. Claude Codeã®çŠ¶æ…‹ã‚’æ¤œå‡º
    local claude_status=""
    if [[ "$target_window" != "." ]]; then
        # ç‰¹å®šã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€ãã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ã‚’å–å¾—
        claude_status=$(~/.tmux/scripts/claude-status-enhanced.sh "${target_window%.*}" 2>/dev/null || echo "")
        log "DEBUG" "Detected Claude status: $claude_status"
    fi
    
    # 3. è¦ç´„ç”Ÿæˆ
    echo "ğŸ¤– ${model}ã§è¦ç´„ã‚’ç”Ÿæˆä¸­..."
    local summary
    
    # çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼ˆé€£æƒ³é…åˆ—ã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ï¼‰
    if [[ "${BASH_VERSION%%.*}" -ge 4 ]] && declare -f create_summary_options >/dev/null && declare -f generate_unified_summary >/dev/null; then
        # æ–°ã—ã„çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆBash 4ä»¥é™ï¼‰
        declare -A summary_options
        create_summary_options summary_options
        
        summary_options[content]="$screen_text"
        summary_options[max_length]=$(summary_type_to_length "$summary_type")
        summary_options[context]=$(status_to_context "$claude_status")
        summary_options[format]="speech_optimized"
        
        summary=$(generate_unified_summary summary_options)
    else
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥å‘¼ã³å‡ºã—
        local max_length=50
        case "$summary_type" in
            "detailed") max_length=100 ;;
            "technical") max_length=80 ;;
            "brief"|*) max_length=50 ;;
        esac
        
        local context="general"
        if [[ "$claude_status" == "âœ…" ]] || [[ "$claude_status" == "Idle" ]]; then
            context="complete"
        elif [[ "$claude_status" == "âŒ›" ]] || [[ "$claude_status" == "Waiting" ]]; then
            context="waiting"
        elif [[ "$claude_status" == "âš¡" ]] || [[ "$claude_status" == "Busy" ]]; then
            context="busy"
        fi
        
        summary=$(summarize_screen_content "$screen_text" "$max_length" "$context")
    fi
    
    if [[ -z "$summary" ]] || [[ "$summary" == "è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ" ]]; then
        local error_msg="è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        echo "âŒ $error_msg"
        speak_text "$error_msg" "$voice"
        exit 1
    fi
    
    echo "âœ… è¦ç´„ç”Ÿæˆå®Œäº†"
    
    # 4. éŸ³å£°å‡ºåŠ›
    echo "ğŸ”Š éŸ³å£°ã§èª­ã¿ä¸Šã’ä¸­..."
    
    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦IDã®æŠ½å‡ºï¼ˆãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ç”¨ï¼‰
    local window_id_for_panning=""
    if [[ "$target_window" != "." && "$target_window" =~ ^([0-9]+)\..*$ ]]; then
        window_id_for_panning="${BASH_REMATCH[1]}"
        log "DEBUG" "Extracted window ID for panning: $window_id_for_panning"
    fi
    
    if ! speak_text "$summary" "$voice" "$device" "200" "$window_id_for_panning"; then
        log "WARN" "Speech synthesis failed, showing text only"
        echo "ğŸ“ è¦ç´„å†…å®¹: $summary"
    fi
    
    # 5. å®Œäº†é€šçŸ¥
    local total_duration=$(end_timer "$start_time")
    echo "âœ… å‡¦ç†å®Œäº† (ç·æ™‚é–“: ${total_duration}s)"
    
    # çµ±è¨ˆè¨˜éŒ²
    record_usage_stats "$summary_type" "$model" "$(detect_os)" "$total_duration" "true"
    
    log "INFO" "claude-voice completed successfully (${total_duration}s)"
    
    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    claude_voice_cleanup
    
    return 0
}

# å¼•æ•°ã®æ¤œè¨¼
validate_arguments() {
    local summary_type="$1"
    local lines="$2"
    local voice="$3"
    local model="$4"
    
    # è¦ç´„ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    local valid_type=false
    for type in "${SUMMARY_TYPES[@]}"; do
        if [[ "$summary_type" == "$type" ]]; then
            valid_type=true
            break
        fi
    done
    
    if [[ "$valid_type" != "true" ]]; then
        log "ERROR" "Invalid summary type: $summary_type"
        return 1
    fi
    
    # è¡Œæ•°ã®æ¤œè¨¼
    if ! [[ "$lines" =~ ^[0-9]+$ ]] || [[ $lines -lt 1 ]] || [[ $lines -gt 1000 ]]; then
        log "ERROR" "Invalid lines value: $lines (must be 1-1000)"
        return 1
    fi
    
    log "DEBUG" "Arguments validated successfully"
    return 0
}

# éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
initialize_audio_subsystem() {
    local os_type=$(detect_os)
    
    log "DEBUG" "Initializing audio subsystem for OS: $os_type"
    
    case "$os_type" in
        "darwin")
            if declare -f init_macos_audio >/dev/null; then
                init_macos_audio
            else
                log "ERROR" "macOS audio initialization function not found"
                return 1
            fi
            ;;
        "linux")
            if declare -f init_linux_audio >/dev/null; then
                init_linux_audio
            else
                log "ERROR" "Linux audio initialization function not found"
                return 1
            fi
            ;;
        "windows")
            if declare -f init_windows_audio >/dev/null; then
                init_windows_audio
            else
                log "ERROR" "Windows audio initialization function not found"
                return 1
            fi
            ;;
        *)
            log "WARN" "Unknown OS type, using basic audio initialization"
            return 0
            ;;
    esac
}

# ä½¿ç”¨çµ±è¨ˆã®è¨˜éŒ²
record_usage_stats() {
    local summary_type="$1"
    local model="$2"
    local os_type="$3"
    local duration="$4"
    local success="$5"
    
    local timestamp=$(get_timestamp)
    local stats_entry=$(cat << EOF
{
    "timestamp": $timestamp,
    "operation": "claude_voice_main",
    "summary_type": "$summary_type",
    "model": "$model", 
    "os_type": "$os_type",
    "duration": $duration,
    "success": $success,
    "version": "$CLAUDE_VOICE_VERSION"
}
EOF
)
    
    # çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
    mkdir -p "$CLAUDE_VOICE_HOME/logs"
    echo "$stats_entry" >> "$CLAUDE_VOICE_HOME/logs/usage_stats.jsonl"
}

# ãƒ˜ãƒ«ãƒ—ãƒ»ä½¿ç”¨æ³•ã®è¡¨ç¤º
show_usage() {
    cat << EOF
Claude Voice v$CLAUDE_VOICE_VERSION - ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ éŸ³å£°é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

ä½¿ç”¨æ³•: $(basename "$0") [OPTIONS] [SUMMARY_TYPE] [LINES] [VOICE] [MODEL] [DEVICE]

SUMMARY_TYPE:
  brief         ç°¡æ½”ãªè¦ç´„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  detailed      è©³ç´°ãªè¦ç´„  
  technical     æŠ€è¡“çš„ãªè¦ç´„

LINES:          å–å¾—ã™ã‚‹ç”»é¢ã®è¡Œæ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: $DEFAULT_LINESï¼‰
VOICE:          ä½¿ç”¨ã™ã‚‹éŸ³å£°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: autoï¼‰
MODEL:          ä½¿ç”¨ã™ã‚‹LLMãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: autoï¼‰
DEVICE:         ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒã‚¤ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: system_defaultï¼‰
                - system_default: ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºåŠ›
                - alert_device: ã‚¢ãƒ©ãƒ¼ãƒˆéŸ³ãƒ‡ãƒã‚¤ã‚¹
                - sound_effects: ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ‡ãƒã‚¤ã‚¹

OPTIONS:
  -h, --help    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  -v, --version ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  -d, --debug   ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
  --stats       ä½¿ç”¨çµ±è¨ˆã‚’è¡¨ç¤º
  --test        ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  --config      è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º/ç·¨é›†

ä¾‹:
  $(basename "$0")                          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§å®Ÿè¡Œ
  $(basename "$0") brief 30                 # ç°¡æ½”è¦ç´„ã€30è¡Œ
  $(basename "$0") detailed 50 Kyoko        # è©³ç´°è¦ç´„ã€50è¡Œã€KyokoéŸ³å£°
  $(basename "$0") technical 40 auto phi4-mini:latest  # æŠ€è¡“çš„è¦ç´„ã€æŒ‡å®šãƒ¢ãƒ‡ãƒ«

ç’°å¢ƒå¤‰æ•°:
  CLAUDE_VOICE_HOME    ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ~/.tmux/claudeï¼‰
  DEBUG_MODE          ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆtrue/falseï¼‰

å¯¾å¿œOS: macOS, Linux, Windows/WSL
EOF
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®è¡¨ç¤º
show_version() {
    echo "Claude Voice $CLAUDE_VOICE_VERSION"
    echo "OS: $(detect_os)"
    echo "Home: $CLAUDE_VOICE_HOME"
    echo ""
    echo "Core modules:"
    for module in base screen_capture llm_manager summary_engine; do
        local module_path="$CLAUDE_VOICE_HOME/core/${module}.sh"
        if [[ -f "$module_path" ]]; then
            echo "  âœ… $module"
        else
            echo "  âŒ $module (missing)"
        fi
    done
    echo ""
    echo "OS-specific module:"
    local os_module="$CLAUDE_VOICE_HOME/os/$(detect_os).sh"
    if [[ -f "$os_module" ]]; then
        echo "  âœ… $(detect_os)"
    else
        echo "  âŒ $(detect_os) (missing)"
    fi
}

# çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
show_stats() {
    echo "=== Claude Voice ä½¿ç”¨çµ±è¨ˆ ==="
    
    local stats_file="$CLAUDE_VOICE_HOME/logs/usage_stats.jsonl"
    if [[ ! -f "$stats_file" ]]; then
        echo "çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        return 1
    fi
    
    # åŸºæœ¬çµ±è¨ˆ
    local total_uses=$(wc -l < "$stats_file")
    local successful_uses=$(grep '"success":"true"' "$stats_file" | wc -l)
    local success_rate=$(echo "scale=1; $successful_uses * 100 / $total_uses" | bc 2>/dev/null || echo "0")
    
    echo "ç·ä½¿ç”¨å›æ•°: $total_uses"
    echo "æˆåŠŸç‡: ${success_rate}%"
    
    # æœ€è¿‘ã®ä½¿ç”¨çŠ¶æ³
    local day_ago=$(($(date +%s) - 86400))
    local recent_uses=$(awk -v threshold="$day_ago" '$0 ~ /"timestamp":[0-9]+/ && $0 ~ threshold {print}' "$stats_file" 2>/dev/null | wc -l)
    echo "24æ™‚é–“ã®ä½¿ç”¨å›æ•°: $recent_uses"
    
    # å¹³å‡å‡¦ç†æ™‚é–“
    if has_command jq; then
        local avg_duration=$(grep '"success":"true"' "$stats_file" | jq -r '.duration' | awk '{sum+=$1; count++} END {if(count>0) printf("%.2f", sum/count); else print "0"}')
        echo "å¹³å‡å‡¦ç†æ™‚é–“: ${avg_duration}ç§’"
        
        # OSåˆ¥çµ±è¨ˆ
        echo ""
        echo "OSåˆ¥ä½¿ç”¨çŠ¶æ³:"
        grep '"success":"true"' "$stats_file" | jq -r '.os_type' | sort | uniq -c | while read count os; do
            echo "  $os: $countå›"
        done
        
        # è¦ç´„ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ
        echo ""
        echo "è¦ç´„ã‚¿ã‚¤ãƒ—åˆ¥ä½¿ç”¨çŠ¶æ³:"
        grep '"success":"true"' "$stats_file" | jq -r '.summary_type' | sort | uniq -c | while read count type; do
            echo "  $type: $countå›"
        done
    fi
    
    echo ""
    echo "æœ€è¿‘ã®5å›ã®ä½¿ç”¨:"
    tail -5 "$stats_file" | while read line; do
        if has_command jq; then
            local timestamp=$(echo "$line" | jq -r '.timestamp')
            local type=$(echo "$line" | jq -r '.summary_type')
            local success=$(echo "$line" | jq -r '.success')
            local duration=$(echo "$line" | jq -r '.duration')
            local date_str=$(date -r "$timestamp" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || date "+%Y-%m-%d %H:%M:%S")
            
            local status_icon="âœ…"
            if [[ "$success" != "true" ]]; then
                status_icon="âŒ"
            fi
            
            echo "  $date_str - $type - $status_icon - ${duration}s"
        else
            echo "  $line"
        fi
    done
}

# å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ
run_health_check() {
    echo "=== Claude Voice Health Check ==="
    echo ""
    
    local health_score=0
    local total_checks=0
    local issues=()
    
    # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®èª­ã¿è¾¼ã¿
    if [[ -f "$CLAUDE_VOICE_HOME/core/integration.sh" ]]; then
        source "$CLAUDE_VOICE_HOME/core/integration.sh" >/dev/null 2>&1
    fi
    
    echo "1. Configuration Health..."
    ((total_checks++))
    
    if [[ -f "$CLAUDE_VOICE_HOME/config/claude-voice.yaml" ]]; then
        echo "   âœ… YAML configuration file exists"
        
        # YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if command -v yq >/dev/null 2>&1; then
            if yq eval '.' "$CLAUDE_VOICE_HOME/config/claude-voice.yaml" >/dev/null 2>&1; then
                echo "   âœ… YAML syntax is valid"
                ((health_score++))
            else
                echo "   âŒ YAML syntax errors detected"
                issues+=("yaml_syntax")
            fi
        else
            echo "   âš ï¸  yq not available for YAML validation"
            ((health_score += 0.5))
        fi
    else
        echo "   âŒ Configuration file missing"
        issues+=("config_missing")
    fi
    
    echo ""
    echo "2. Integration Layer Health..."
    ((total_checks++))
    
    if declare -f get_integration_status >/dev/null 2>&1; then
        local integration_status=$(get_integration_status)
        case "$integration_status" in
            "fully_functional")
                echo "   âœ… Integration layer: Fully functional"
                ((health_score++))
                ;;
            "degraded")
                echo "   âš ï¸  Integration layer: Degraded functionality"
                issues+=("integration_degraded")
                ((health_score += 0.5))
                ;;
            *)
                echo "   âŒ Integration layer: Disabled or non-functional"
                issues+=("integration_failed")
                ;;
        esac
    else
        echo "   âŒ Integration layer not accessible"
        issues+=("integration_missing")
    fi
    
    echo ""
    echo "3. Audio System Health..."
    ((total_checks++))
    
    local os_type=$(detect_os)
    case "$os_type" in
        "darwin")
            if command -v say >/dev/null 2>&1; then
                echo "   âœ… macOS say command available"
                
                if osascript -e 'get volume settings' >/dev/null 2>&1; then
                    echo "   âœ… Audio session accessible"
                    ((health_score++))
                else
                    echo "   âŒ Audio session not accessible"
                    issues+=("audio_session_failed")
                fi
            else
                echo "   âŒ macOS say command not available"
                issues+=("say_command_missing")
            fi
            ;;
        *)
            echo "   âš ï¸  Audio system check not implemented for $os_type"
            ((health_score += 0.5))
            ;;
    esac
    
    echo ""
    echo "4. LLM Integration Health..."
    ((total_checks++))
    
    if check_ollama_health >/dev/null 2>&1; then
        echo "   âœ… Ollama connection successful"
        ((health_score++))
    else
        echo "   âŒ Ollama connection failed"
        issues+=("ollama_failed")
    fi
    
    echo ""
    echo "5. File System Health..."
    ((total_checks++))
    
    local required_dirs=("$CLAUDE_VOICE_HOME/core" "$CLAUDE_VOICE_HOME/config" "$CLAUDE_VOICE_HOME/logs")
    local missing_dirs=()
    
    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            missing_dirs+=("$dir")
        fi
    done
    
    if [[ ${#missing_dirs[@]} -eq 0 ]]; then
        echo "   âœ… All required directories exist"
        ((health_score++))
    else
        echo "   âŒ Missing directories: ${missing_dirs[*]}"
        issues+=("missing_directories")
    fi
    
    # çµæœã®è¡¨ç¤º
    echo ""
    echo "=== Health Check Results ==="
    local health_percentage=$(( (health_score * 100) / total_checks ))
    echo "Overall Health Score: $health_score/$total_checks ($health_percentage%)"
    
    if [[ ${#issues[@]} -eq 0 ]]; then
        echo "ğŸ‰ System is healthy!"
        return 0
    else
        echo ""
        echo "âš ï¸  Issues detected:"
        for issue in "${issues[@]}"; do
            case "$issue" in
                "yaml_syntax")
                    echo "  - YAML configuration has syntax errors"
                    echo "    Fix: Run 'claude-voice --repair-configuration'"
                    ;;
                "config_missing")
                    echo "  - Configuration file missing"
                    echo "    Fix: Run 'claude-voice config-reset'"
                    ;;
                "integration_degraded")
                    echo "  - Integration layer has reduced functionality"
                    echo "    Fix: Check dependencies and run 'claude-voice --integration-test'"
                    ;;
                "audio_session_failed")
                    echo "  - Audio session not accessible"
                    echo "    Fix: Check system audio settings and permissions"
                    ;;
                "ollama_failed")
                    echo "  - Ollama LLM service not available"
                    echo "    Fix: Start Ollama service or check connection"
                    ;;
                *)
                    echo "  - $issue"
                    ;;
            esac
        done
        
        if [[ $health_percentage -lt 50 ]]; then
            return 2  # Critical health issues
        else
            return 1  # Minor health issues
        fi
    fi
}

# çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
run_integration_test() {
    echo "=== Claude Voice Integration Test ==="
    echo ""
    
    local test_passed=0
    local test_total=0
    
    echo "Testing complete integration workflow..."
    echo ""
    
    # ãƒ†ã‚¹ãƒˆ1: è¨­å®šã‚·ã‚¹ãƒ†ãƒ 
    echo "1. Configuration System Test..."
    ((test_total++))
    
    if [[ -f "$CLAUDE_VOICE_HOME/core/config_manager.sh" ]]; then
        if "$CLAUDE_VOICE_HOME/core/config_manager.sh" validate >/dev/null 2>&1; then
            echo "   âœ… Configuration system working"
            ((test_passed++))
        else
            echo "   âŒ Configuration system failed"
        fi
    else
        echo "   âŒ Configuration manager not found"
    fi
    
    # ãƒ†ã‚¹ãƒˆ2: çµ±åˆãƒ¬ã‚¤ãƒ¤ãƒ¼
    echo "2. Integration Layer Test..."
    ((test_total++))
    
    if [[ -f "$CLAUDE_VOICE_HOME/core/integration.sh" ]]; then
        if "$CLAUDE_VOICE_HOME/core/integration.sh" test >/dev/null 2>&1; then
            echo "   âœ… Integration layer working"
            ((test_passed++))
        else
            echo "   âŒ Integration layer failed"
        fi
    else
        echo "   âŒ Integration script not found"
    fi
    
    # ãƒ†ã‚¹ãƒˆ3: tmuxçµ±åˆ
    echo "3. tmux Integration Test..."
    ((test_total++))
    
    if [[ -n "${TMUX:-}" ]]; then
        if tmux list-keys | grep -q "C-v"; then
            echo "   âœ… tmux key bindings configured"
            ((test_passed++))
        else
            echo "   âŒ tmux key bindings not found"
        fi
    else
        echo "   âš ï¸  Not running in tmux session"
    fi
    
    # ãƒ†ã‚¹ãƒˆ4: ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
    echo "4. End-to-End Test (dry run)..."
    ((test_total++))
    
    if [[ -x "$CLAUDE_VOICE_HOME/bin/claude-voice" ]]; then
        if "$CLAUDE_VOICE_HOME/bin/claude-voice" --help >/dev/null 2>&1; then
            echo "   âœ… End-to-end path accessible"
            ((test_passed++))
        else
            echo "   âŒ End-to-end execution failed"
        fi
    else
        echo "   âŒ Claude Voice binary not executable"
    fi
    
    # çµæœè¡¨ç¤º
    echo ""
    echo "Integration Test Results: $test_passed/$test_total tests passed"
    
    if [[ $test_passed -eq $test_total ]]; then
        echo "ğŸ‰ All integration tests passed!"
        return 0
    else
        echo "âŒ Some integration tests failed"
        return 1
    fi
}

# è¨­å®šä¿®å¾©æ©Ÿèƒ½
repair_configuration() {
    echo "=== Claude Voice Configuration Repair ==="
    echo ""
    
    local repairs_made=0
    
    # 1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä¿®å¾©
    echo "1. Checking directory structure..."
    local required_dirs=(
        "$CLAUDE_VOICE_HOME/core"
        "$CLAUDE_VOICE_HOME/config" 
        "$CLAUDE_VOICE_HOME/logs"
        "$CLAUDE_VOICE_HOME/bin"
    )
    
    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            echo "   Creating missing directory: $dir"
            mkdir -p "$dir"
            ((repairs_made++))
        fi
    done
    
    # 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®å¾©
    echo "2. Checking configuration files..."
    
    if [[ ! -f "$CLAUDE_VOICE_HOME/config/claude-voice.yaml" ]]; then
        echo "   Creating default YAML configuration..."
        if [[ -f "$CLAUDE_VOICE_HOME/core/config_manager.sh" ]]; then
            "$CLAUDE_VOICE_HOME/core/config_manager.sh" init
            ((repairs_made++))
        fi
    fi
    
    # 3. å®Ÿè¡Œæ¨©é™ã®ä¿®å¾©
    echo "3. Checking executable permissions..."
    local executable_files=(
        "$CLAUDE_VOICE_HOME/bin/claude-voice"
        "$CLAUDE_VOICE_HOME/core/integration.sh"
        "$CLAUDE_VOICE_HOME/core/config_manager.sh"
        "$CLAUDE_VOICE_HOME/session-hook.sh"
        "$CLAUDE_VOICE_HOME/voice-trigger.sh"
    )
    
    for file in "${executable_files[@]}"; do
        if [[ -f "$file" ]] && [[ ! -x "$file" ]]; then
            echo "   Setting executable permission: $file"
            chmod +x "$file"
            ((repairs_made++))
        fi
    done
    
    # 4. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
    echo "4. Initializing log files..."
    local log_files=(
        "$CLAUDE_VOICE_HOME/logs/claude-voice.log"
        "$CLAUDE_VOICE_HOME/logs/integration.log"
    )
    
    for log_file in "${log_files[@]}"; do
        if [[ ! -f "$log_file" ]]; then
            echo "   Creating log file: $log_file"
            touch "$log_file"
            ((repairs_made++))
        fi
    done
    
    echo ""
    if [[ $repairs_made -gt 0 ]]; then
        echo "âœ… Configuration repair completed: $repairs_made repairs made"
        echo "   Run 'claude-voice --health-check' to verify the repairs"
    else
        echo "âœ… No repairs needed - configuration appears healthy"
    fi
    
    return 0
}

# ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
run_system_test() {
    echo "=== Claude Voice ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ ==="
    echo ""
    
    local test_passed=0
    local test_total=0
    
    # ãƒ†ã‚¹ãƒˆ1: ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    echo "1. ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ..."
    ((test_total++))
    
    local all_core_modules_present=true
    for module in base screen_capture llm_manager summary_engine; do
        local module_path="$CLAUDE_VOICE_HOME/core/${module}.sh"
        if [[ ! -f "$module_path" ]]; then
            echo "   âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $module"
            all_core_modules_present=false
        fi
    done
    
    if [[ "$all_core_modules_present" == "true" ]]; then
        echo "   âœ… ã™ã¹ã¦ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå­˜åœ¨"
        ((test_passed++))
    fi
    
    # ãƒ†ã‚¹ãƒˆ2: OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    echo "2. OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ..."
    ((test_total++))
    
    local os_type=$(detect_os)
    local os_module="$CLAUDE_VOICE_HOME/os/${os_type}.sh"
    if [[ -f "$os_module" ]]; then
        echo "   âœ… OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå­˜åœ¨: $os_type"
        ((test_passed++))
    else
        echo "   âŒ OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $os_type"
    fi
    
    # ãƒ†ã‚¹ãƒˆ3: éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ 
    echo "3. éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ..."
    ((test_total++))
    
    if initialize_audio_subsystem; then
        echo "   âœ… éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æˆåŠŸ"
        ((test_passed++))
    else
        echo "   âŒ éŸ³å£°ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—"
    fi
    
    # ãƒ†ã‚¹ãƒˆ4: tmuxçµ±åˆ
    echo "4. tmuxçµ±åˆãƒ†ã‚¹ãƒˆ..."
    ((test_total++))
    
    if [[ -n "$TMUX" ]] && has_command tmux; then
        local test_capture=$(capture_screen_text "." 5 2>/dev/null)
        if [[ -n "$test_capture" ]]; then
            echo "   âœ… tmuxç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£æˆåŠŸ"
            ((test_passed++))
        else
            echo "   âš ï¸  tmuxç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã¯å‹•ä½œã™ã‚‹ãŒå†…å®¹ãŒç©º"
        fi
    else
        echo "   âš ï¸  tmuxç’°å¢ƒå¤–ã§å®Ÿè¡Œä¸­"
    fi
    
    # ãƒ†ã‚¹ãƒˆ5: LLMçµ±åˆ
    echo "5. LLMçµ±åˆãƒ†ã‚¹ãƒˆ..."
    ((test_total++))
    
    if check_ollama_health; then
        echo "   âœ… Ollamaæ¥ç¶šæˆåŠŸ"
        ((test_passed++))
    else
        echo "   âš ï¸  Ollamaæ¥ç¶šå¤±æ•—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã¯åˆ©ç”¨å¯èƒ½ï¼‰"
    fi
    
    # çµæœè¡¨ç¤º
    echo ""
    echo "ãƒ†ã‚¹ãƒˆçµæœ: $test_passed/$test_total é …ç›®ãŒæ­£å¸¸"
    
    if [[ $test_passed -eq $test_total ]]; then
        echo "ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        return 0
    elif [[ $test_passed -gt $((test_total / 2)) ]]; then
        echo "âš ï¸  ä¸€éƒ¨ã®æ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ä½œã—ã¾ã™ã€‚"
        return 0
    else
        echo "âŒ é‡è¦ãªæ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi
}

# è¨­å®šç®¡ç†
manage_config() {
    local action="${1:-show}"
    local config_file="$CLAUDE_VOICE_HOME/config/claude-voice.conf"
    
    case "$action" in
        "show")
            echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: $config_file"
            if [[ -f "$config_file" ]]; then
                echo ""
                cat "$config_file"
            else
                echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§å‹•ä½œã—ã¾ã™ã€‚"
            fi
            ;;
        "edit")
            if [[ -f "$config_file" ]]; then
                "${EDITOR:-nano}" "$config_file"
            else
                echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
                read -r response
                if [[ "$response" =~ ^[yY] ]]; then
                    mkdir -p "$(dirname "$config_file")"
                    create_default_config "$config_file"
                    "${EDITOR:-nano}" "$config_file"
                fi
            fi
            ;;
        "reset")
            echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
            read -r response
            if [[ "$response" =~ ^[yY] ]]; then
                mkdir -p "$(dirname "$config_file")"
                create_default_config "$config_file"
                echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ: $config_file"
            fi
            ;;
    esac
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
create_default_config() {
    local config_file="$1"
    
    cat > "$config_file" << 'EOF'
# Claude Voice Configuration File

[llm]
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ« (auto, phi4-mini:latest, orca-mini:latest, ãªã©)
default_model=auto
# Ollama API URL
ollama.api_url=http://localhost:11434
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
timeout=30
# æœ€å¤§å†è©¦è¡Œå›æ•°
max_retries=3
# æœ€å¤§å…¥åŠ›æ–‡å­—æ•°
max_input_chars=2000

[audio]
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£° (auto, Kyoko, ãªã©)
default_voice=auto
# éŸ³å£°é€Ÿåº¦ (macOS: 100-300, Linux: 100-200, Windows: -10-10)
speech_rate=200
# æœ€å¤§éŸ³å£°é•·ï¼ˆæ–‡å­—æ•°ï¼‰
max_speech_length=500
# é€šçŸ¥éŸ³ (Glass, Hero, Ping, ãªã©)
notification_sound=Glass
# Do Not Disturb ã‚’å°Šé‡ã™ã‚‹ã‹ (true/false)
respect_dnd=true
# ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡ (0-100)
volume=80

[capture]
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå–å¾—è¡Œæ•°
default_lines=50
# æœ€å¤§æ–‡å­—æ•°
max_chars=2000

[logging]
# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« (DEBUG, INFO, WARN, ERROR)
level=INFO
# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
file=~/.tmux/claude/logs/claude-voice.log

[test]
# ãƒ†ã‚¹ãƒˆæ™‚ã®éŸ³å£°å†ç”Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ (true/false)
enable_speech=false
EOF
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®åˆ†å²
case "${1:-main}" in
    "-h"|"--help"|"help")
        show_usage
        ;;
    "-v"|"--version"|"version")
        show_version
        ;;
    "-d"|"--debug"|"debug")
        export DEBUG_MODE=true
        claude_voice_init true
        main "${@:2}"
        ;;
    "--stats"|"stats")
        show_stats
        ;;
    "--test"|"test")
        run_system_test
        ;;
    "--health-check"|"health-check")
        run_health_check
        ;;
    "--integration-test"|"integration-test")  
        run_integration_test
        ;;
    "--repair-configuration"|"repair-configuration")
        repair_configuration
        ;;
    "--config"|"config")
        manage_config "${2:-show}"
        ;;
    "config-edit")
        manage_config "edit"
        ;;
    "config-reset")
        manage_config "reset"
        ;;
    *)
        main "$@"
        ;;
esac