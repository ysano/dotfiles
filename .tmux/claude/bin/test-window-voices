#!/bin/bash
# Claude Voice - Window Voice Assignment Test
# Otoyaã¨Kyoko (Enhanced)ã®éŸ³å£°å‰²ã‚Šå½“ã¦ãƒ†ã‚¹ãƒˆ

CLAUDE_VOICE_HOME="${CLAUDE_VOICE_HOME:-$HOME/.tmux/claude}"
source "$CLAUDE_VOICE_HOME/core/spatial_audio.sh"

echo "ğŸ­ Window Voice Assignment Test"
echo "================================"
echo ""

# è¤‡æ•°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
test_multiple_windows() {
    local window_counts=(1 2 3 4 5)
    
    for count in "${window_counts[@]}"; do
        echo "Testing with $count window(s):"
        echo "----------------------------"
        
        for ((i=0; i<count; i++)); do
            local voice=$(assign_voice_to_window "$i")
            local panning=$(calculate_db_panning "$count" "$i")
            IFS='|' read -r left right <<< "$panning"
            local left_db=$(linear_to_db "$left")
            local right_db=$(linear_to_db "$right")
            
            printf "  Window %d: Voice=%-20s Pan: L=%.1fdB, R=%.1fdB" "$i" "$voice" "$left_db" "$right_db"
            
            # ä½ç½®ã®èª¬æ˜ã‚’è¿½åŠ 
            if [[ $count -eq 1 ]]; then
                echo " (Center)"
            elif [[ $i -eq 0 ]]; then
                echo " (Far Left)"
            elif [[ $i -eq $((count-1)) ]]; then
                echo " (Far Right)"
            elif [[ $i -eq $((count/2)) ]]; then
                echo " (Center)"
            else
                echo ""
            fi
        done
        echo ""
    done
}

# ãƒ‡ãƒ¢éŸ³å£°å†ç”Ÿ
play_demo_voices() {
    echo "ğŸ”Š Playing Voice Demo with 3 simulated windows"
    echo ""
    
    local window_count=3
    local test_text="ã“ã‚Œã¯ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦"
    
    for ((i=0; i<window_count; i++)); do
        local voice=$(assign_voice_to_window "$i")
        local panning=$(calculate_db_panning "$window_count" "$i")
        IFS='|' read -r left_gain right_gain <<< "$panning"
        
        local position=""
        if [[ $i -eq 0 ]]; then
            position="å·¦"
        elif [[ $i -eq 1 ]]; then
            position="ä¸­å¤®"
        else
            position="å³"
        fi
        
        echo "  Window $i: $voice (${position})"
        
        # éŸ³å£°ã‚’ç”Ÿæˆã—ã¦å†ç”Ÿ
        local window_text="${test_text}${i}ã§ã™ã€‚${position}ã‹ã‚‰èã“ãˆã¾ã™ã€‚"
        
        if command -v say >/dev/null 2>&1; then
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            local temp_audio="/tmp/claude_voice_test_${i}.aiff"
            say -v "$voice" -r 200 -o "$temp_audio" "$window_text" 2>/dev/null
            
            # ffplayãŒã‚ã‚‹å ´åˆã¯ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ä»˜ãã§å†ç”Ÿ
            if command -v ffplay >/dev/null 2>&1; then
                ffplay -nodisp -autoexit -loglevel quiet \
                    -af "pan=stereo|c0=${left_gain}*c0|c1=${right_gain}*c0" \
                    "$temp_audio" 2>/dev/null &
            else
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸å†ç”Ÿ
                afplay "$temp_audio" 2>/dev/null &
            fi
            
            # å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦è­˜åˆ¥ã—ã‚„ã™ãã™ã‚‹
            sleep 1.5
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            rm -f "$temp_audio"
        else
            echo "    âš ï¸  say command not available"
        fi
    done
    
    # ã™ã¹ã¦ã®éŸ³å£°å†ç”Ÿã‚’å¾…ã¤
    wait
    echo ""
    echo "âœ… Demo completed"
}

# ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
show_menu() {
    echo ""
    echo "Select test option:"
    echo "  1) Show voice assignment patterns"
    echo "  2) Play voice demo (3 windows)"
    echo "  3) Test actual Claude Code windows"
    echo "  4) Exit"
    echo ""
    echo -n "Option: "
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    while true; do
        show_menu
        read -r option
        
        case "$option" in
            1)
                echo ""
                test_multiple_windows
                ;;
            2)
                echo ""
                play_demo_voices
                ;;
            3)
                echo ""
                echo "ğŸ” Detecting actual Claude Code windows..."
                play_spatial_claude_voices "ãƒ†ã‚¹ãƒˆéŸ³å£°" "auto"
                ;;
            4)
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo "Invalid option"
                ;;
        esac
    done
}

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å‡¦ç†
if [[ $# -gt 0 ]]; then
    case "$1" in
        "pattern")
            test_multiple_windows
            ;;
        "demo")
            play_demo_voices
            ;;
        "actual")
            play_spatial_claude_voices "ãƒ†ã‚¹ãƒˆéŸ³å£°" "auto"
            ;;
        *)
            echo "Usage: $(basename "$0") [pattern|demo|actual]"
            exit 1
            ;;
    esac
else
    main
fi