#!/bin/bash
# Claude Voice - Spatial Audio CLI
# ãƒ‡ã‚·ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã®ç©ºé–“éŸ³éŸ¿é…ç½®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«

# ç’°å¢ƒè¨­å®š
CLAUDE_VOICE_HOME="${CLAUDE_VOICE_HOME:-$HOME/.tmux/claude}"
export CLAUDE_VOICE_HOME

# åŸºæœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
source "$CLAUDE_VOICE_HOME/core/base.sh" 2>/dev/null || {
    echo "Error: Base module not found" >&2
    exit 1
}

# spatial_audioãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
source "$CLAUDE_VOICE_HOME/core/spatial_audio.sh" 2>/dev/null || {
    echo "Error: Spatial audio module not found" >&2
    exit 1
}

# audio_managerã®èª­ã¿è¾¼ã¿
source "$CLAUDE_VOICE_HOME/core/audio_manager.sh" 2>/dev/null || true

# OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
if [[ "$OSTYPE" == "darwin"* ]]; then
    source "$CLAUDE_VOICE_HOME/os/darwin.sh" 2>/dev/null || true
fi

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    cat <<EOF
Claude Voice Spatial Audio - ãƒ‡ã‚·ãƒ™ãƒ«ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«

ä½¿ç”¨æ³•: $(basename "$0") [COMMAND] [OPTIONS]

ã‚³ãƒãƒ³ãƒ‰:
  detect              Claude Codeã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ¤œå‡º
  test [text]         ç©ºé–“éŸ³å£°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  play <text>         æŒ‡å®šãƒ†ã‚­ã‚¹ãƒˆã‚’ç©ºé–“é…ç½®ã§å†ç”Ÿ
  calc <count> <pos>  ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°è¨ˆç®—ã‚’ãƒ†ã‚¹ãƒˆ
  demo                ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ä¾‹:
  $(basename "$0") detect              # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ¤œå‡º
  $(basename "$0") test                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ã‚¹ãƒˆ
  $(basename "$0") play "ã“ã‚“ã«ã¡ã¯"   # ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆ
  $(basename "$0") calc 5 2            # 5ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¸­3ç•ªç›®ã®è¨ˆç®—
  $(basename "$0") demo                # ãƒ•ãƒ«ãƒ‡ãƒ¢

èª¬æ˜:
  Claude Codeã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å„tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®éŸ³å£°ã‚’
  å·¦ã‹ã‚‰å³ã¸ãƒ‡ã‚·ãƒ™ãƒ«çš„ã«å‡ç­‰é…ç½®ã—ã¦å†ç”Ÿã—ã¾ã™ã€‚
  Equal Power Pan Law (3dB center)ã‚’ä½¿ç”¨ã—ãŸ
  è‡ªç„¶ãªéŸ³éŸ¿å®šä½ã‚’å®Ÿç¾ã—ã¾ã™ã€‚
EOF
}

# ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ¤œå‡º
detect_windows() {
    echo "ğŸ” Detecting Claude Code windows..."
    echo ""
    
    local windows=$(detect_claude_windows)
    local count=$(echo "$windows" | grep -c '^[0-9]' || echo 0)
    
    if [[ $count -eq 0 ]]; then
        echo "âŒ No Claude Code windows found"
        echo ""
        echo "Tip: Start Claude Code in a tmux window with:"
        echo "  claude.ai/code"
    else
        echo "âœ… Found $count Claude Code window(s):"
        echo "$windows" | while read -r window_id; do
            [[ -n "$window_id" ]] && {
                local window_name=$(tmux display-message -t "$window_id" -p "#{window_name}" 2>/dev/null)
                echo "  Window $window_id: $window_name"
            }
        done
    fi
}

# ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°è¨ˆç®—ãƒ†ã‚¹ãƒˆ
test_calculation() {
    local window_count="${1:-3}"
    local window_index="${2:-1}"
    
    echo "ğŸ“ Testing panning calculation..."
    echo "  Windows: $window_count"
    echo "  Position: $window_index (0-based)"
    echo ""
    
    local panning=$(calculate_db_panning "$window_count" "$window_index")
    IFS='|' read -r left right <<< "$panning"
    
    # ãƒ‡ã‚·ãƒ™ãƒ«å¤‰æ›
    local left_db=$(linear_to_db "$left")
    local right_db=$(linear_to_db "$right")
    
    echo "  Linear gains: L=$left, R=$right"
    echo "  Decibel: L=${left_db}dB, R=${right_db}dB"
    echo ""
    
    # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
    echo "  Stereo field visualization:"
    echo -n "  L "
    
    # ãƒãƒ¼ã‚°ãƒ©ãƒ•è¡¨ç¤º
    local left_bar=$(echo "scale=0; $left * 20" | bc)
    local right_bar=$(echo "scale=0; $right * 20" | bc)
    
    for ((i=0; i<20; i++)); do
        if [[ $i -lt ${left_bar%.*} ]]; then
            echo -n "â–ˆ"
        else
            echo -n "â–‘"
        fi
    done
    
    echo -n " C "
    
    for ((i=0; i<20; i++)); do
        if [[ $i -lt ${right_bar%.*} ]]; then
            echo -n "â–ˆ"
        else
            echo -n "â–‘"
        fi
    done
    
    echo " R"
}

# ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
demo() {
    echo "ğŸ­ Spatial Audio Demonstration"
    echo "================================"
    echo ""
    
    echo "1. Window detection..."
    detect_windows
    echo ""
    
    echo "2. Panning calculation examples..."
    echo ""
    
    for count in 2 3 5; do
        echo "With $count windows:"
        for ((i=0; i<count; i++)); do
            local panning=$(calculate_db_panning "$count" "$i")
            IFS='|' read -r left right <<< "$panning"
            local left_db=$(linear_to_db "$left")
            local right_db=$(linear_to_db "$right")
            printf "  Window %d: L=%5.1fdB  R=%5.1fdB  " "$i" "$left_db" "$right_db"
            
            # ç°¡æ˜“ã‚°ãƒ©ãƒ•
            local left_level=$(echo "scale=0; ($left * 10)" | bc)
            local right_level=$(echo "scale=0; ($right * 10)" | bc)
            echo -n "["
            for ((j=0; j<5; j++)); do
                [[ $j -lt ${left_level%.*} ]] && echo -n "â—€" || echo -n "-"
            done
            echo -n "|"
            for ((j=0; j<5; j++)); do
                [[ $j -lt ${right_level%.*} ]] && echo -n "â–¶" || echo -n "-"
            done
            echo "]"
        done
        echo ""
    done
    
    echo "3. Playing spatial audio test..."
    play_spatial_claude_voices "ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="${1:-help}"
    shift
    
    case "$command" in
        "detect")
            detect_windows
            ;;
        "test")
            local text="${1:-ç©ºé–“éŸ³éŸ¿ãƒ†ã‚¹ãƒˆ}"
            play_spatial_claude_voices "$text"
            ;;
        "play")
            local text="${1:-ãƒ†ã‚¹ãƒˆ}"
            play_spatial_claude_voices "$text"
            ;;
        "calc")
            test_calculation "$@"
            ;;
        "demo")
            demo
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            echo "Error: Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi