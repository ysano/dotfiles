#!/bin/bash
# Claude Voice - Audio Control CLI
# éŸ³é‡èª¿æ•´ã¨ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«

# ç’°å¢ƒè¨­å®š
CLAUDE_VOICE_HOME="${CLAUDE_VOICE_HOME:-$HOME/.tmux/claude}"
export CLAUDE_VOICE_HOME

# åŸºæœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
source "$CLAUDE_VOICE_HOME/core/base.sh" 2>/dev/null || {
    echo "Error: Base module not found" >&2
    exit 1
}

# audio_managerã®èª­ã¿è¾¼ã¿
source "$CLAUDE_VOICE_HOME/core/audio_manager.sh" 2>/dev/null || {
    echo "Error: Audio manager not found" >&2
    exit 1
}

# OSå›ºæœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
if declare -f detect_os >/dev/null; then
    OS_TYPE=$(detect_os)
else
    # ç°¡æ˜“OSæ¤œå‡º
    if [[ "$OSTYPE" == "darwin"* ]]; then
        OS_TYPE="darwin"
    elif [[ -f /proc/version ]] && grep -q Microsoft /proc/version; then
        OS_TYPE="wsl"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS_TYPE="linux"
    else
        OS_TYPE="unknown"
    fi
fi

if [[ -f "$CLAUDE_VOICE_HOME/os/$OS_TYPE.sh" ]]; then
    source "$CLAUDE_VOICE_HOME/os/$OS_TYPE.sh"
fi

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    cat <<EOF
Claude Voice Audio Control - éŸ³é‡èª¿æ•´ãƒ„ãƒ¼ãƒ«

ä½¿ç”¨æ³•: $(basename "$0") [COMMAND] [OPTIONS]

ã‚³ãƒãƒ³ãƒ‰:
  get [key]           ç¾åœ¨ã®éŸ³é‡è¨­å®šã‚’è¡¨ç¤º
  set <key> <value>   éŸ³é‡è¨­å®šã‚’å¤‰æ›´
  preset <name>       ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ (quiet/normal/loud)
  test [type]         éŸ³å£°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  list                åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’ä¸€è¦§è¡¨ç¤º
  system <volume>     ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡ã‚’èª¿æ•´ (macOS only, 0-100)

éŸ³é‡è¨­å®šã‚­ãƒ¼:
  macos.say.volume       macOSéŸ³å£°åˆæˆã®éŸ³é‡ (0.0-1.0)
  sound_effects.volume   åŠ¹æœéŸ³ã®éŸ³é‡ (0.0-1.0)
  alert.volume          é€šçŸ¥éŸ³ã®éŸ³é‡ (0.0-1.0)
  speech_rate           èª­ã¿ä¸Šã’é€Ÿåº¦ (120-300)
  default_voice         ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°å

ä¾‹:
  $(basename "$0") preset quiet           # é™éŸ³ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
  $(basename "$0") set macos.say.volume 0.7  # éŸ³å£°åˆæˆã®éŸ³é‡ã‚’70%ã«è¨­å®š
  $(basename "$0") test speech            # éŸ³å£°åˆæˆãƒ†ã‚¹ãƒˆ
  $(basename "$0") test sound             # åŠ¹æœéŸ³ãƒ†ã‚¹ãƒˆ
  $(basename "$0") system 50              # ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡ã‚’50%ã«è¨­å®š
EOF
}

# éŸ³å£°ãƒ†ã‚¹ãƒˆ
test_audio() {
    local test_type="${1:-speech}"
    
    case "$test_type" in
        "speech")
            echo "ğŸ”Š éŸ³å£°åˆæˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            
            # ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º
            local params=$(get_speech_params "$OS_TYPE")
            IFS='|' read -r voice rate volume <<< "$params"
            echo "  éŸ³å£°: $voice"
            echo "  é€Ÿåº¦: $rate"
            echo "  éŸ³é‡: $volume"
            echo ""
            
            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            local test_text="ã“ã‚Œã¯éŸ³é‡ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç¾åœ¨ã®éŸ³é‡ã¯$(echo "$volume * 100" | bc -l | cut -d. -f1)ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§ã™ã€‚"
            
            if [[ "$OS_TYPE" == "macos" ]] && declare -f speak_text >/dev/null; then
                speak_text "$test_text" "$voice" "auto" "$rate"
            elif [[ "$OS_TYPE" == "wsl" ]] && command -v powershell.exe >/dev/null; then
                powershell.exe -Command "Add-Type -AssemblyName System.Speech; \$s=New-Object System.Speech.Synthesis.SpeechSynthesizer; \$s.SelectVoice('$voice'); \$s.Rate=$((rate/50-4)); \$s.Volume=$((volume)); \$s.Speak('$test_text')"
            else
                echo "  âš ï¸  ã“ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯éŸ³å£°åˆæˆãƒ†ã‚¹ãƒˆã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“"
            fi
            ;;
            
        "sound")
            echo "ğŸ”” åŠ¹æœéŸ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            
            local volume=$(get_platform_volume "sound" "$OS_TYPE")
            echo "  éŸ³é‡: $volume"
            echo ""
            
            # ãƒ†ã‚¹ãƒˆéŸ³ã‚’å†ç”Ÿ
            if [[ "$OS_TYPE" == "macos" ]]; then
                # macOSã®ã‚·ã‚¹ãƒ†ãƒ éŸ³ã‚’å†ç”Ÿ
                afplay -v "$volume" /System/Library/Sounds/Glass.aiff 2>/dev/null || {
                    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ“ãƒ¼ãƒ—éŸ³
                    printf '\a'
                }
            else
                # ãã®ä»–ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
                printf '\a'
            fi
            ;;
            
        "all")
            echo "ğŸµ å…¨éŸ³å£°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            echo ""
            test_audio "speech"
            sleep 2
            test_audio "sound"
            ;;
            
        *)
            echo "Error: Unknown test type: $test_type"
            echo "Available types: speech, sound, all"
            return 1
            ;;
    esac
}

# åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’ä¸€è¦§è¡¨ç¤º
list_voices() {
    echo "ğŸ“¢ åˆ©ç”¨å¯èƒ½ãªéŸ³å£°:"
    echo ""
    
    if [[ "$OS_TYPE" == "macos" ]]; then
        say -v '?' 2>/dev/null | grep -E "ja_JP|en_US" | awk '{print "  " $1 " (" $2 ")"}'
    elif [[ "$OS_TYPE" == "wsl" ]] && command -v powershell.exe >/dev/null; then
        powershell.exe -Command "Add-Type -AssemblyName System.Speech; (New-Object System.Speech.Synthesis.SpeechSynthesizer).GetInstalledVoices() | ForEach-Object { Write-Host '  ' \$_.VoiceInfo.Name }"
    else
        echo "  âš ï¸  ã“ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯éŸ³å£°ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“"
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="${1:-help}"
    shift
    
    case "$command" in
        "get")
            audio_config_cli get "$@"
            ;;
        "set")
            audio_config_cli set "$@"
            ;;
        "preset")
            audio_config_cli preset "$@"
            echo ""
            echo "âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n)"
            read -r response
            if [[ "$response" == "y" ]]; then
                test_audio "speech"
            fi
            ;;
        "test")
            test_audio "$@"
            ;;
        "list")
            list_voices
            ;;
        "system")
            if [[ "$OS_TYPE" == "macos" ]]; then
                local volume="${1:-50}"
                echo "ğŸ”Š ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡ã‚’ ${volume}% ã«è¨­å®šä¸­..."
                adjust_macos_system_volume "$volume" "output"
            else
                echo "Error: System volume control is only available on macOS"
                exit 1
            fi
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            echo "Error: Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi